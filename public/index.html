<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vapi Call Manager</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <style>
    body {
      background-color: #f8f9fa;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .card {
      border-radius: 15px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s ease;
    }
    .card:hover {
      transform: translateY(-5px);
    }
    .header-bg {
      background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
      color: white;
      border-radius: 15px 15px 0 0;
      padding: 20px;
    }
    .btn-primary {
      background-color: #6a11cb;
      border-color: #6a11cb;
    }
    .btn-primary:hover {
      background-color: #5a0cb9;
      border-color: #5a0cb9;
    }
    .call-history {
      max-height: 300px;
      overflow-y: auto;
    }
    .status-badge {
      font-size: 0.8rem;
    }
    .call-item {
      transition: background-color 0.2s ease;
    }
    .call-item:hover {
      background-color: #f1f1f1;
    }
    .loader {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container py-5">
    <div class="row justify-content-center">
      <div class="col-md-8">
        <div class="card mb-4">
          <div class="header-bg">
            <h1 class="mb-0"><i class="bi bi-telephone"></i> Vapi Call Manager</h1>
            <p class="mb-0">Initiate AI-powered calls with ease</p>
          </div>
          <div class="card-body">
            <form id="callForm">
              <div class="mb-3">
                <label for="phoneNumber" class="form-label">Phone Number (E.164 format)</label>
                <div class="input-group">
                  <span class="input-group-text"><i class="bi bi-phone"></i></span>
                  <input type="tel" class="form-control" id="phoneNumber" placeholder="+12345678900" required>
                </div>
                <div class="form-text">Example: +12345678900</div>
              </div>
              <button type="submit" class="btn btn-primary w-100" id="submitBtn">
                <i class="bi bi-telephone-outbound"></i> Initiate Call
              </button>
            </form>
          </div>
        </div>

        <div class="card">
          <div class="card-header bg-light">
            <h5 class="mb-0"><i class="bi bi-clock-history"></i> Recent Calls</h5>
          </div>
          <div class="card-body p-0">
            <div id="callHistory" class="call-history">
              <div class="text-center py-4 text-muted">
                <i class="bi bi-telephone-x display-4"></i>
                <p>No calls initiated yet</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Call Details Modal -->
  <div class="modal fade" id="callDetailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Call Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="callDetailsContent">
            <div class="text-center">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <p>Loading call details...</p>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Store call history in memory
    const callHistory = [];
    const callDetailsModal = new bootstrap.Modal(document.getElementById('callDetailsModal'));
    
    document.getElementById('callForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const phoneNumber = document.getElementById('phoneNumber').value;
      const submitBtn = document.getElementById('submitBtn');
      
      // Disable button and show loading state
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span class="loader"></span> Initiating call...';
      
      try {
        const response = await fetch('http://localhost:3000/initiate-call', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ phoneNumber }),
        });
        
        const data = await response.json();
        
        if (!response.ok) {
          throw new Error(data.message || 'Failed to initiate call');
        }
        
        // Add to call history
        const callData = {
          id: data.callId,
          phoneNumber,
          status: data.callDetails.status || 'queued',
          timestamp: new Date().toISOString(),
          details: data.callDetails
        };
        
        callHistory.unshift(callData);
        updateCallHistoryUI();
        
        // Start polling for call status
        if (data.callId) {
          pollCallStatus(data.callId);
        }
        
        // Show success message
        alert('Call initiated successfully!');
      } catch (error) {
        console.error('Error initiating call:', error);
        alert(`Error: ${error.message}`);
      } finally {
        // Re-enable button
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="bi bi-telephone-outbound"></i> Initiate Call';
      }
    });
    
    function updateCallHistoryUI() {
      const historyContainer = document.getElementById('callHistory');
      
      if (callHistory.length === 0) {
        historyContainer.innerHTML = `
          <div class="text-center py-4 text-muted">
            <i class="bi bi-telephone-x display-4"></i>
            <p>No calls initiated yet</p>
          </div>
        `;
        return;
      }
      
      let html = '<ul class="list-group list-group-flush">';
      
      callHistory.forEach(call => {
        const date = new Date(call.timestamp).toLocaleString();
        let statusBadge = '';
        
        switch(call.status) {
          case 'queued':
            statusBadge = '<span class="badge bg-secondary">Queued</span>';
            break;
          case 'ringing':
            statusBadge = '<span class="badge bg-warning text-dark">Ringing</span>';
            break;
          case 'in-progress':
            statusBadge = '<span class="badge bg-success">In Progress</span>';
            break;
          case 'ended':
            statusBadge = '<span class="badge bg-danger">Ended</span>';
            break;
          default:
            statusBadge = `<span class="badge bg-info">${call.status}</span>`;
        }
        
        html += `
          <li class="list-group-item call-item" data-call-id="${call.id}">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <i class="bi bi-telephone"></i> ${call.phoneNumber}
                <div class="text-muted small">${date}</div>
              </div>
              <div>
                ${statusBadge}
                <button class="btn btn-sm btn-outline-primary ms-2 view-details-btn" data-call-id="${call.id}">
                  <i class="bi bi-info-circle"></i> Details
                </button>
              </div>
            </div>
          </li>
        `;
      });
      
      html += '</ul>';
      historyContainer.innerHTML = html;
      
      // Add event listeners to view details buttons
      document.querySelectorAll('.view-details-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const callId = this.getAttribute('data-call-id');
          showCallDetails(callId);
        });
      });
    }
    
    function showCallDetails(callId) {
      // Show modal
      callDetailsModal.show();
      
      // Fetch latest call details
      fetch(`http://localhost:3000/call/${callId}`)
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            const callDetails = data.callDetails;
            
            // Update call status in our local history
            const callIndex = callHistory.findIndex(call => call.id === callId);
            if (callIndex !== -1) {
              callHistory[callIndex].status = callDetails.status;
              callHistory[callIndex].details = callDetails;
              updateCallHistoryUI();
            }
            
            // Format the details for display
            let detailsHtml = `
              <div class="card mb-3">
                <div class="card-header">
                  <h5>Call Information</h5>
                </div>
                <div class="card-body">
                  <div class="row">
                    <div class="col-md-6">
                      <p><strong>Call ID:</strong> ${callDetails.id}</p>
                      <p><strong>Status:</strong> ${callDetails.status || 'Unknown'}</p>
                      <p><strong>Created:</strong> ${new Date(callDetails.createdAt).toLocaleString()}</p>
                      ${callDetails.startedAt ? `<p><strong>Started:</strong> ${new Date(callDetails.startedAt).toLocaleString()}</p>` : ''}
                      ${callDetails.endedAt ? `<p><strong>Ended:</strong> ${new Date(callDetails.endedAt).toLocaleString()}</p>` : ''}
                    </div>
                    <div class="col-md-6">
                      <p><strong>Phone Number:</strong> ${callDetails.customer?.number || 'N/A'}</p>
                      <p><strong>Assistant ID:</strong> ${callDetails.assistantId || 'N/A'}</p>
                      ${callDetails.endedReason ? `<p><strong>Ended Reason:</strong> ${callDetails.endedReason}</p>` : ''}
                      ${callDetails.cost ? `<p><strong>Cost:</strong> $${callDetails.cost.toFixed(4)}</p>` : ''}
                    </div>
                  </div>
                </div>
              </div>
            `;
            
            // Add transcript if available
            if (callDetails.artifact && callDetails.artifact.transcript) {
              detailsHtml += `
                <div class="card">
                  <div class="card-header">
                    <h5>Transcript</h5>
                  </div>
                  <div class="card-body">
                    <pre class="bg-light p-3 rounded">${callDetails.artifact.transcript}</pre>
                  </div>
                </div>
              `;
            } else if (callDetails.artifact && callDetails.artifact.messages && callDetails.artifact.messages.length > 0) {
              detailsHtml += `
                <div class="card">
                  <div class="card-header">
                    <h5>Conversation</h5>
                  </div>
                  <div class="card-body">
                    <div class="conversation-log">
              `;
              
              callDetails.artifact.messages.forEach(msg => {
                const time = new Date(msg.time).toLocaleTimeString();
                const role = msg.role === 'assistant' ? 'AI Assistant' : 'User';
                const bgClass = msg.role === 'assistant' ? 'bg-light' : 'bg-primary text-white';
                
                detailsHtml += `
                  <div class="mb-3">
                    <div class="small text-muted">${role} at ${time}</div>
                    <div class="p-3 rounded ${bgClass}">${msg.message}</div>
                  </div>
                `;
              });
              
              detailsHtml += `
                    </div>
                  </div>
                </div>
              `;
            }
            
            document.getElementById('callDetailsContent').innerHTML = detailsHtml;
          } else {
            document.getElementById('callDetailsContent').innerHTML = `
              <div class="alert alert-danger">
                Failed to load call details: ${data.error || 'Unknown error'}
              </div>
            `;
          }
        })
        .catch(error => {
          document.getElementById('callDetailsContent').innerHTML = `
            <div class="alert alert-danger">
              Error loading call details: ${error.message}
            </div>
          `;
        });
    }
    
    async function pollCallStatus(callId) {
      try {
        const response = await fetch(`http://localhost:3000/call/${callId}`);
        const data = await response.json();
        
        if (response.ok) {
          // Update call in history
          const callIndex = callHistory.findIndex(call => call.id === callId);
          if (callIndex !== -1) {
            callHistory[callIndex].status = data.callDetails.status;
            callHistory[callIndex].details = data.callDetails;
            updateCallHistoryUI();
          }
          
          // Continue polling if call is still active
          if (['scheduled', 'queued', 'ringing', 'in-progress'].includes(data.callDetails.status)) {
            setTimeout(() => pollCallStatus(callId), 5000); // Poll every 5 seconds
          }
        }
      } catch (error) {
        console.error('Error polling call status:', error);
      }
    }
  </script>
</body>
</html>